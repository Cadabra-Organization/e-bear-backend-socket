<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>SSE ì‹¤ì‹œê°„ ì•ŒëŒ í…ŒìŠ¤íŠ¸</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; line-height: 1.6; }
        .container { max-width: 600px; margin: 0 auto; border: 1px solid #ddd; padding: 20px; border-radius: 10px; }
        #alarm-list { height: 300px; border: 1px solid #eee; background: #fafafa; overflow-y: auto; padding: 10px; margin-top: 10px; border-radius: 5px; }
        .alarm-item { background: #fff; border-left: 5px solid #007bff; padding: 10px; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .status { font-weight: bold; margin-bottom: 10px; }
        .online { color: green; } .offline { color: red; }
        input { padding: 8px; width: 200px; }
        button { padding: 8px 15px; cursor: pointer; background: #007bff; color: white; border: none; border-radius: 3px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ”” ì‹¤ì‹œê°„ ì•ŒëŒ ì„¼í„°</h2>

    <div class="status">
        ìƒíƒœ: <span id="connection-status" class="offline">ì—°ê²° ì•ˆë¨</span>
    </div>

    <div style="margin-bottom: 20px;">
        <input type="text" id="userId" placeholder="ë‚´ ì•„ì´ë”” ì…ë ¥ (ì˜ˆ: user1)">
        <button onclick="startSse()">ì•ŒëŒ êµ¬ë… ì‹œì‘</button>
    </div>

    <hr>

    <h4>ì•ŒëŒ ëª©ë¡</h4>
    <div id="alarm-list">
    </div>
</div>

<script>
    let eventSource = null;

    function startSse() {
        const userId = document.getElementById('userId').value;
        if (!userId) {
            alert("ì•„ì´ë””ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            return;
        }

        if (eventSource !== null) {
            eventSource.close();
        }

        // 1. ì„œë²„ì˜ êµ¬ë… ì—”ë“œí¬ì¸íŠ¸ë¡œ ì—°ê²°
        eventSource = new EventSource(`http://localhost:9191/subscribe/${userId}`);

        // [ì—°ê²° ì„±ê³µ ì´ë²¤íŠ¸]
        eventSource.addEventListener('connect', (e) => {
            const status = document.getElementById('connection-status');
            status.innerText = "ì—°ê²°ë¨ (ID: " + userId + ")";
            status.className = "online";
            addAlarm("ì‹œìŠ¤í…œ: " + e.data);
        });

        // [ì„œë²„ì—ì„œ ë³´ë‚´ëŠ” 'alarm' ì´ë²¤íŠ¸ ìˆ˜ì‹ ]
        eventSource.addEventListener('alarm', (e) => {
            addAlarm("ğŸ“¢ ìƒˆ ì•ŒëŒ: " + e.data);

            // ë¸Œë¼ìš°ì € ê¸°ë³¸ ì•Œë¦¼ì°½ ë„ìš°ê¸° (ì„ íƒ ì‚¬í•­)
            if (Notification.permission === "granted") {
                new Notification("ìƒˆ ì•ŒëŒ ë„ì°©", { body: e.data });
            }
        });

        // [ì—ëŸ¬ ë°œìƒ ì‹œ]
        eventSource.onerror = (e) => {
            console.error("SSE ì—ëŸ¬ ë°œìƒ", e);
            document.getElementById('connection-status').innerText = "ì—°ê²° ëŠê¹€/ì—ëŸ¬";
            document.getElementById('connection-status').className = "offline";
            eventSource.close();
        };
    }

    function addAlarm(message) {
        const list = document.getElementById('alarm-list');
        const item = document.createElement('div');
        item.className = 'alarm-item';
        item.innerText = message;
        list.prepend(item); // ìµœì‹  ì•ŒëŒì´ ìœ„ë¡œ ì˜¤ê²Œ ì¶”ê°€
    }

    // ë¸Œë¼ìš°ì € ì•Œë¦¼ ê¶Œí•œ ìš”ì²­
    if (Notification.permission !== "denied") {
        Notification.requestPermission();
    }
</script>

</body>
</html>